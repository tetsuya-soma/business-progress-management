<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥­å‹™é€²æ—ç®¡ç†è¡¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'ãƒ¡ã‚¤ãƒªã‚ª', 'Meiryo', sans-serif;
            background: #f5f5f5;
            padding: 0;
            color: #333;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #1a5490;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: normal;
        }
        
        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .office-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .office-selector select {
            padding: 6px 12px;
            border-radius: 3px;
            border: none;
            font-size: 14px;
            background: white;
            color: #333;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .year-selector select {
            padding: 6px 12px;
            border-radius: 3px;
            border: none;
            font-size: 14px;
            background: white;
            color: #333;
        }
        
        .edit-status {
            background: #ffc107;
            color: #333;
            padding: 5px 15px;
            border-radius: 3px;
            font-size: 13px;
            display: none;
        }
        
        .edit-status.active {
            display: block;
        }
        
        .tabs-container {
            background: #2a6bb3;
            display: flex;
            padding: 0;
            border-bottom: none;
        }
        
        .tab {
            padding: 10px 20px;
            background: #4d8fd9;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            flex: 1;
            text-align: center;
            border-right: 1px solid #2a6bb3;
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        .tab:hover {
            background: #5a9ae5;
        }
        
        .tab.active {
            background: #6ba5e9;
        }
        
        .table-container {
            flex: 1;
            overflow: auto;
            position: relative;
            padding: 10px;
        }
        
        table {
            border-collapse: collapse;
            font-size: 12px;
            width: auto;
            table-layout: fixed;
            background: white;
        }
        
        th, td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: center;
            white-space: nowrap;
        }
        
        th {
            background: #e9ecef;
            font-weight: normal;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }
        
        th:hover {
            background: #dee2e6;
        }
        
        /* å›ºå®šåˆ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .fixed-column {
            position: sticky;
            background: white;
            z-index: 5;
        }
        
        th.fixed-column {
            background: #e9ecef;
            z-index: 11;
            border-right: 2px solid #999;
        }
        
        td.fixed-column {
            border-right: 2px solid #999;
        }
        
        .fixed-no {
            left: 0;
            width: 40px;
            min-width: 40px;
            max-width: 40px;
        }
        
        .fixed-name {
            left: 40px;
            width: 150px;
            min-width: 150px;
            max-width: 150px;
        }
        
        .fixed-work {
            left: 190px;
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }
        
        .row-number {
            background: #f8f9fa;
            font-weight: normal;
            color: #666;
        }
        
        .customer-name {
            text-align: left;
            font-weight: 500;
        }
        
        .work-number {
            font-weight: 500;
        }
        
        .building-location {
            min-width: 200px;
            text-align: left;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .editable {
            cursor: text;
            padding: 4px;
            min-height: 25px;
            display: block;
            width: 100%;
        }
        
        .editable:hover {
            background: #e3f2fd;
        }
        
        .editable:focus {
            outline: 2px solid #2196f3;
            background: white;
        }
        
        .cell-input {
            border: none;
            background: transparent;
            width: 100%;
            text-align: center;
            padding: 4px;
            font-size: 12px;
        }
        
        .cell-input:focus {
            outline: 2px solid #2196f3;
            background: white;
        }
        
        .input-type-toggle {
            position: absolute;
            right: 2px;
            top: 2px;
            font-size: 10px;
            background: #e3f2fd;
            border: none;
            padding: 2px 4px;
            cursor: pointer;
            border-radius: 2px;
            display: none;
        }
        
        td:hover .input-type-toggle {
            display: block;
        }
        
        .delete-row {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .delete-row:hover {
            background: #c82333;
        }
        
        .highlight {
            background: #fff3cd !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .modal-row {
            margin-bottom: 15px;
        }
        
        .modal-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 13px;
        }
        
        .modal-input, .modal-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-add {
            background: #28a745;
        }
        
        .btn-add:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .column-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
        }
        
        .column-checkbox {.column-settings-list {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ddd;
    margin: 10px 0;
}

.column-setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid #eee;
}

.column-setting-item:hover {
    background: #f5f5f5;
}

.column-setting-item span {
    font-weight: 500;
}

.column-setting-item label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}.column-settings-list {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ddd;
    margin: 10px 0;
}

.column-setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid #eee;
}

.column-setting-item:hover {
    background: #f5f5f5;
}

.column-setting-item span {
    font-weight: 500;
}

.column-setting-item label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}
            display: block;
            margin: 5px 0;
        }
        
        .column-checkbox input {
            margin-right: 8px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.warning {
            background: #ffc107;
            color: #333;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .column-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
        }
        
        .column-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .column-item:hover {
            background: #f5f5f5;
        }
        
        .column-item input {
            flex: 1;
            margin-right: 10px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .column-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* åˆ—å¹…ã®å‹•çš„èª¿æ•´ */
        .auto-width {
            width: auto;
            min-width: 80px;
        }
        
        .text-left {
            text-align: left !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ¥­å‹™é€²æ—ç®¡ç†è¡¨</h1>
            <div class="header-info">
                <div class="office-selector">
                    <label for="office">å–¶æ¥­æ‰€ï¼š</label>
                    <select id="office">
                        <option value="sapporo">æœ­å¹Œå–¶æ¥­æ‰€</option>
                        <option value="tokyo">æ±äº¬å–¶æ¥­æ‰€</option>
                        <option value="osaka">å¤§é˜ªå–¶æ¥­æ‰€</option>
                        <option value="fukuoka">ç¦å²¡å–¶æ¥­æ‰€</option>
                    </select>
                </div>
                <div class="year-selector">
                    <select id="year">
                        <option value="2025">2025å¹´4æœˆï½2026å¹´3æœˆ</option>
                        <option value="2024">2024å¹´4æœˆï½2025å¹´3æœˆ</option>
                        <option value="2023">2023å¹´4æœˆï½2024å¹´3æœˆ</option>
                    </select>
                </div>
                <div class="edit-status" id="editStatus">
                    âš ï¸ ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç·¨é›†ä¸­ã§ã™
                </div>
            </div>
        </div>
        
        <div class="tabs-container">
            <button class="tab active" onclick="showEditCustomerModal()">é¡§å®¢ã‚’ç·¨é›†</button>
            <button class="tab" onclick="showEditColumnModal()">åˆ—ã‚’ç·¨é›†</button>
            <button class="tab" onclick="showColumnVisibilityModal()">è¡¨ç¤ºåˆ—ã®é¸æŠ</button>
            <button class="tab" onclick="showColumnSettingsModal()">åˆ—ã®å›ºå®šè¨­å®š</button>
            <button class="tab" onclick="saveData()">ä¿å­˜</button>
            <button class="tab" onclick="exportToCSV()">CSVå‡ºåŠ›</button>
            <button class="tab" onclick="importData()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <button class="tab" onclick="document.getElementById('excelFileInput').click()">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="headerRow"></tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- é¡§å®¢ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editCustomerModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">é¡§å®¢ã®ç·¨é›†</h3>
            <div class="modal-row">
                <button class="btn btn-add" onclick="showAddCustomerForm()">â• æ–°è¦é¡§å®¢ã‚’è¿½åŠ </button>
            </div>
            <div id="addCustomerForm" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 5px; margin-bottom: 20px;">
                <div class="modal-row">
                    <label class="modal-label">æŒ¿å…¥ä½ç½®</label>
                    <select id="rowPosition" class="modal-select">
                        <option value="end">æœ€å¾Œã«è¿½åŠ </option>
                    </select>
                </div>
                <div class="modal-row">
                    <label class="modal-label">é¡§å®¢å</label>
                    <input type="text" id="customerName" class="modal-input" placeholder="ä¾‹: å±±ç”° å¤ªéƒ">
                </div>
                <div class="modal-row">
                    <label class="modal-label">å·¥äº‹No</label>
                    <input type="text" id="workNumber" class="modal-input" placeholder="ä¾‹: 251001">
                </div>
                <div class="modal-row">
                    <label class="modal-label">ãƒ•ãƒªã‚¬ãƒŠ</label>
                    <input type="text" id="furigana" class="modal-input" placeholder="ä¾‹: ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦">
                </div>
                <div class="modal-row">
                    <label class="modal-label">å»ºç¯‰åœ°</label>
                    <input type="text" id="buildingLocation" class="modal-input" placeholder="ä¾‹: æœ­å¹Œå¸‚ä¸­å¤®åŒº">
                </div>
                <div class="modal-row">
                    <label class="modal-label">èè³‡</label>
                    <input type="text" id="financing" class="modal-input" placeholder="ä¾‹: é“éŠ€">
                </div>
                <button class="btn btn-add" onclick="addRow()">è¿½åŠ </button>
                <button class="btn btn-danger" onclick="hideAddCustomerForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <div class="column-list" id="customerList"></div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('editCustomerModal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- åˆ—ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editColumnModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">åˆ—ã®ç·¨é›†</h3>
            <div class="modal-row">
                <button class="btn btn-add" onclick="showAddColumnForm()">â• æ–°è¦åˆ—ã‚’è¿½åŠ </button>
            </div>
            <div id="addColumnForm" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 5px; margin-bottom: 20px;">
                <div class="modal-row">
                    <label class="modal-label">åˆ—å</label>
                    <input type="text" id="columnName" class="modal-input" placeholder="åˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
                <div class="modal-row">
                    <label class="modal-label">æŒ¿å…¥ä½ç½®</label>
                    <select id="columnPosition" class="modal-select">
                        <option value="end">æœ€å¾Œã«è¿½åŠ </option>
                    </select>
                </div>
                <button class="btn btn-add" onclick="addColumn()">è¿½åŠ </button>
                <button class="btn btn-danger" onclick="hideAddColumnForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <div class="column-list" id="columnList"></div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('editColumnModal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- åˆ—è¡¨ç¤ºé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="columnVisibilityModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header">è¡¨ç¤ºã™ã‚‹åˆ—ã‚’é¸æŠ</h3>
            <div class="column-selector" id="columnSelector"></div>
            <div class="modal-buttons">
                <button class="btn" onclick="applyColumnVisibility()">é©ç”¨</button>
                <button class="btn btn-danger" onclick="closeModal('columnVisibilityModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="fileInput" style="display: none;" accept=".json,.csv">
    <input type="file" id="excelFileInput" style="display: none;" accept=".xlsx,.xls,.csv">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let data = [];
        let columns = [
            let columns = [
    { name: 'No', visible: true, fixed: true, editable: false },
    { name: 'é¡§å®¢å', visible: true, fixed: true, editable: true },
    { name: 'å·¥äº‹No', visible: true, fixed: true, editable: true },
    { name: 'ãƒ•ãƒªã‚¬ãƒŠ', visible: true, fixed: false, editable: true },
    { name: 'å»ºç¯‰åœ°', visible: true, fixed: false, editable: true },
    { name: 'èè³‡', visible: true, fixed: false, editable: true },
    { name: 'ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼', visible: true, fixed: false, editable: true },
    { name: 'è¨­è¨ˆ', visible: true, fixed: false, editable: true },
    { name: 'IC', visible: true, fixed: false, editable: true },
    { name: 'å·¥äº‹', visible: true, fixed: false, editable: true },
    { name: 'ç®¡ç†', visible: true, fixed: false, editable: true },
    { name: 'ç©ç®—', visible: true, fixed: false, editable: true },
    { name: 'è§£ä½“', visible: true, fixed: false, editable: true },
    { name: 'ç¾èª¿', visible: true, fixed: false, editable: true },
    { name: 'å¥‘ç´„', visible: true, fixed: false, editable: true },
    { name: 'ãƒ—ãƒ©ãƒ³æ±ºå®š', visible: true, fixed: false, editable: true },
    { name: 'ãƒ—ãƒ©ãƒ³å¤‰æ›´', visible: true, fixed: false, editable: true },
    { name: 'åœ°ç›¤èª¿æŸ»', visible: true, fixed: false, editable: true },
    { name: 'é£æ–¹ç«‹åˆ', visible: true, fixed: false, editable: true },
    { name: 'æ•·åœ°èª¿æŸ»', visible: true, fixed: false, editable: true },
    { name: 'äº‹å‰èè³‡', visible: true, fixed: false, editable: true },
    { name: 'äº‹å‰æ‰¿èª', visible: true, fixed: false, editable: true },
    { name: 'åœŸåœ°å¥‘ç´„', visible: true, fixed: false, editable: true },
    { name: 'èè³‡ç”³è¾¼', visible: true, fixed: false, editable: true },
    { name: 'èè³‡æ‰¿èª', visible: true, fixed: false, editable: true },
    { name: 'åœŸåœ°æ±ºè£', visible: true, fixed: false, editable: true },
    { name: 'ç¢ºèªæå‡º', visible: true, fixed: false, editable: true },
    { name: 'æŠ€è¡“ç”³è«‹', visible: true, fixed: false, editable: true },
    { name: 'èªå®šç”³è«‹', visible: true, fixed: false, editable: true },
    { name: 'æœ€çµ‚å›³é¢ä¾é ¼', visible: true, fixed: false, editable: true },
    { name: 'æ±ºå®šæ‰¿èªå›³', visible: true, fixed: false, editable: true },
    { name: 'ç€å·¥', visible: true, fixed: false, editable: true },
    { name: 'å¤§å·¥ä¹—è¾¼', visible: true, fixed: false, editable: true },
    { name: 'ä¸Šæ£Ÿ', visible: true, fixed: false, editable: true },
    { name: 'å¤§å·¥å®Œäº†', visible: true, fixed: false, editable: true },
    { name: 'å®Œäº†æ¤œæŸ»', visible: true, fixed: false, editable: true },
    { name: 'æ–½ä¸»æ¤œæŸ»', visible: true, fixed: false, editable: true },
    { name: 'å¼•æ¸¡æ—¥ï¼ˆOPæ—¥ï¼‰', visible: true, fixed: false, editable: true },
    { name: 'å¥‘ç´„å®Œæˆ', visible: true, fixed: false, editable: true },
    { name: 'å°å¸³ç«£å·¥', visible: true, fixed: false, editable: true },
    { name: 'å¼•æ¸¡ï¾Œï½§ï½²ï¾™ãŠæ¸¡ã—æ—¥', visible: true, fixed: false, editable: true },
    { name: 'ä¸­é–“ï¼ˆèè³‡ï¼‰', visible: true, fixed: false, editable: true },
    { name: 'ä¸­é–“ï¼ˆè‡ªå·±è³‡é‡‘ï¼‰', visible: true, fixed: false, editable: true },
    { name: 'æœ€çµ‚é‡‘ï¼ˆèè³‡ï¼‰', visible: true, fixed: false, editable: true },
    { name: 'æœ€çµ‚é‡‘ï¼ˆè‡ªå·±è³‡é‡‘ï¼‰', visible: true, fixed: false, editable: true }
];

        
        // ã‚»ãƒ«ã®å…¥åŠ›ã‚¿ã‚¤ãƒ—ã‚’ç®¡ç†
        let cellInputTypes = {};
        
        // ç·¨é›†çŠ¶æ…‹ã®ç®¡ç†ï¼ˆå®Ÿéš›ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…æ™‚ã¯å‰Šé™¤ï¼‰
        let editingUsers = [];
        let editingInterval = null;
        
        // åˆæœŸåŒ–
        function initializeTable() {
            loadData();
            if (data.length === 0) {
                data = [{
                    'No': 1,
                    'é¡§å®¢å': 'ã‚µãƒ³ãƒ—ãƒ«é¡§å®¢',
                    'å·¥äº‹No': '250001',
                    'ãƒ•ãƒªã‚¬ãƒŠ': 'ã‚µãƒ³ãƒ—ãƒ«ã‚³ã‚­ãƒ£ã‚¯',
                    'å»ºç¯‰åœ°': 'æœ­å¹Œå¸‚ä¸­å¤®åŒº',
                    'èè³‡': ''
                }];
            }
            updatePositionSelects();
            renderTable();
            simulateEditingStatus();
        }
        
        // ç·¨é›†çŠ¶æ…‹ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…æ™‚ã¯å®Ÿéš›ã®WebSocketç­‰ã«ç½®ãæ›ãˆï¼‰
        function simulateEditingStatus() {
            editingInterval = setInterval(() => {
                // ãƒ©ãƒ³ãƒ€ãƒ ã«ç·¨é›†ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                if (Math.random() > 0.7) {
                    document.getElementById('editStatus').classList.add('active');
                } else {
                    document.getElementById('editStatus').classList.remove('active');
                }
            }, 5000);
        }
        
        function renderTable() {
            renderHeader();
            renderBody();
        }
        
        function renderHeader() {
            const headerRow = document.getElementById('headerRow');
            headerRow.innerHTML = '';
            
            columns.filter(col => col.visible).forEach((col, index) => {
                const th = document.createElement('th');
                th.onclick = () => showColumnEditDialog(col, index);
                
                if (col.name === 'No') {
                    th.className = 'fixed-column fixed-no row-number';
                } else if (col.name === 'é¡§å®¢å') {
                    th.className = 'fixed-column fixed-name';
                } else if (col.name === 'å·¥äº‹No') {
                    th.className = 'fixed-column fixed-work';
                }
                
                th.textContent = col.name;
                headerRow.appendChild(th);
            });
            
            // æ“ä½œåˆ—
            const actionTh = document.createElement('th');
            actionTh.textContent = 'æ“ä½œ';
            headerRow.appendChild(actionTh);
        }
        
        function renderBody() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                
                columns.filter(col => col.visible).forEach(col => {
                    const td = document.createElement('td');
                    td.style.position = 'relative';
                    
                    const value = row[col.name] || '';
                    const cellKey = `${rowIndex}-${col.name}`;
                    const inputType = cellInputTypes[cellKey] || 'text';
                    
                    if (col.name === 'No') {
                        td.className = 'fixed-column fixed-no row-number';
                        td.textContent = row.No || (rowIndex + 1);
                    } else if (col.name === 'é¡§å®¢å') {
                        td.className = 'fixed-column fixed-name customer-name';
                        td.innerHTML = `<div class="editable" contenteditable="true" 
                                           onblur="updateCell(${rowIndex}, '${col.name}', this.textContent)">${value}</div>`;
                    } else if (col.name === 'å·¥äº‹No') {
                        td.className = 'fixed-column fixed-work work-number';
                        td.innerHTML = `<div class="editable" contenteditable="true" 
                                           onblur="updateCell(${rowIndex}, '${col.name}', this.textContent)">${value}</div>`;
                    } else if (col.name === 'å»ºç¯‰åœ°') {
                        td.className = 'building-location auto-width text-left';
                        td.innerHTML = `<div class="editable" contenteditable="true" 
                                           onblur="updateCell(${rowIndex}, '${col.name}', this.textContent)">${value}</div>`;
                    } else {
                        td.className = 'auto-width';
                        // æ—¥ä»˜å…¥åŠ›ã¨é€šå¸¸å…¥åŠ›ã®åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ãªã‚»ãƒ«
                        if (inputType === 'date') {
                            td.innerHTML = `
                                <input type="date" class="cell-input" value="${convertToDateInput(value)}" 
                                       onchange="updateCell(${rowIndex}, '${col.name}', formatDateValue(this.value))">
                                <button class="input-type-toggle" onclick="toggleInputType(${rowIndex}, '${col.name}')">æ–‡å­—</button>
                            `;
                        } else {
                            td.innerHTML = `
                                <input type="text" class="cell-input" value="${value}" 
                                       onchange="updateCell(${rowIndex}, '${col.name}', this.value)"
                                       placeholder="">
                                <button class="input-type-toggle" onclick="toggleInputType(${rowIndex}, '${col.name}')">ğŸ“…</button>
                            `;
                        }
                    }
                    
                    tr.appendChild(td);
                });
                
                // æ“ä½œåˆ—
                const actionTd = document.createElement('td');
                actionTd.innerHTML = `<button class="delete-row" onclick="deleteRow(${rowIndex})">å‰Šé™¤</button>`;
                tr.appendChild(actionTd);
                
                tbody.appendChild(tr);
            });
        }
        
        function showColumnEditDialog(column, index) {
            if (column.name === 'No') return;
            
            const newName = prompt(`åˆ—åã‚’å¤‰æ›´: "${column.name}"`, column.name);
            if (newName && newName !== column.name) {
                data.forEach(row => {
                    row[newName] = row[column.name];
                    delete row[column.name];
                });
                
                const newCellInputTypes = {};
                Object.keys(cellInputTypes).forEach(key => {
                    const [rowIndex, colName] = key.split('-');
                    if (colName === column.name) {
                        newCellInputTypes[`${rowIndex}-${newName}`] = cellInputTypes[key];
                    } else {
                        newCellInputTypes[key] = cellInputTypes[key];
                    }
                });
                cellInputTypes = newCellInputTypes;
                
                column.name = newName;
                renderTable();
                saveData();
                showNotification('åˆ—åã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
            }
        }
        
        function toggleInputType(rowIndex, columnName) {
            const cellKey = `${rowIndex}-${columnName}`;
            cellInputTypes[cellKey] = cellInputTypes[cellKey] === 'date' ? 'text' : 'date';
            renderTable();
        }
        
        function convertToDateInput(value) {
            if (!value || value.includes('-')) return value;
            const parts = value.split('/');
            if (parts.length === 2) {
                const year = new Date().getFullYear();
                const month = parts[0].padStart(2, '0');
                const day = parts[1].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            return '';
        }
        
        function formatDateValue(dateValue) {
    if (!dateValue) return '';
    const date = new Date(dateValue);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}/${day}`;  // M/Då½¢å¼ã§è¡¨
        }
        
        function showEditCustomerModal() {
            updateCustomerList();
            updatePositionSelects();
            document.getElementById('editCustomerModal').style.display = 'block';
        }
        
        function showEditColumnModal() {
            updateColumnList();
            updatePositionSelects();
            document.getElementById('editColumnModal').style.display = 'block';
        }
        
        function updateCustomerList() {
            const list = document.getElementById('customerList');
            list.innerHTML = '<h4>æ—¢å­˜ã®é¡§å®¢ä¸€è¦§</h4>';
            
            data.forEach((customer, index) => {
                const item = document.createElement('div');
                item.className = 'column-item';
                item.innerHTML = `
                    <input type="text" value="${customer['é¡§å®¢å']}" onchange="updateCustomerName(${index}, this.value)">
                    <input type="text" value="${customer['å·¥äº‹No']}" onchange="updateCustomerWorkNo(${index}, this.value)" style="width: 100px;">
                    <div class="column-actions">
                        <button class="btn btn-danger btn-small" onclick="deleteRow(${index})">å‰Šé™¤</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function updateColumnList() {
            const list = document.getElementById('columnList');
            list.innerHTML = '<h4>æ—¢å­˜ã®åˆ—ä¸€è¦§</h4>';
            
            columns.forEach((column, index) => {
                if (column.name === 'No' || column.fixed) return;
                
                const item = document.createElement('div');
                item.className = 'column-item';
                item.innerHTML = `
                    <input type="text" value="${column.name}" onchange="updateColumnName(${index}, this.value)">
                    <div class="column-actions">
                        <button class="btn btn-danger btn-small" onclick="deleteColumn(${index})">å‰Šé™¤</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function updateCustomerName(index, newName) {
            data[index]['é¡§å®¢å'] = newName;
            updatePositionSelects();
            renderTable();
            saveData();
        }
        
        function updateCustomerWorkNo(index, newNo) {
            data[index]['å·¥äº‹No'] = newNo;
            renderTable();
            saveData();
        }
        
        function updateColumnName(index, newName) {
            const oldName = columns[index].name;
            
            data.forEach(row => {
                row[newName] = row[oldName];
                delete row[oldName];
            });
            
            const newCellInputTypes = {};
            Object.keys(cellInputTypes).forEach(key => {
                const [rowIndex, colName] = key.split('-');
                if (colName === oldName) {
                    newCellInputTypes[`${rowIndex}-${newName}`] = cellInputTypes[key];
                } else {
                    newCellInputTypes[key] = cellInputTypes[key];
                }
            });
            cellInputTypes = newCellInputTypes;
            
            columns[index].name = newName;
            updateColumnList();
            updatePositionSelects();
            renderTable();
            saveData();
        }
        
        function deleteColumn(index) {
            if (confirm(`ã€Œ${columns[index].name}ã€åˆ—ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                const columnName = columns[index].name;
                columns.splice(index, 1);
                
                data.forEach(row => {
                    delete row[columnName];
                });
                
                updateColumnList();
                updatePositionSelects();
                renderTable();
                saveData();
                showNotification('åˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }
        
        function showAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'block';
        }
        
        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'none';
            document.getElementById('customerName').value = '';
            document.getElementById('workNumber').value = '';
            document.getElementById('furigana').value = '';
            document.getElementById('buildingLocation').value = '';
            document.getElementById('financing').value = '';
        }
        
        function showAddColumnForm() {
            document.getElementById('addColumnForm').style.display = 'block';
        }
        
        function hideAddColumnForm() {
            document.getElementById('addColumnForm').style.display = 'none';
            document.getElementById('columnName').value = '';
        }
        
        function updatePositionSelects() {
            const rowSelect = document.getElementById('rowPosition');
            if (rowSelect) {
                rowSelect.innerHTML = '<option value="end">æœ€å¾Œã«è¿½åŠ </option>';
                data.forEach((row, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `ã€Œ${row['é¡§å®¢å'] || 'No.' + (row.No || index + 1)}ã€ã®å‰ã«æŒ¿å…¥`;
                    rowSelect.appendChild(option);
                });
            }
            
            const colSelect = document.getElementById('columnPosition');
            if (colSelect) {
                colSelect.innerHTML = '<option value="end">æœ€å¾Œã«è¿½åŠ </option>';
                columns.forEach((col, index) => {
                    if (!col.fixed) {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `ã€Œ${col.name}ã€ã®å‰ã«æŒ¿å…¥`;
                        colSelect.appendChild(option);
                    }
                });
            }
        }
        
        function showColumnVisibilityModal() {
            const selector = document.getElementById('columnSelector');
            selector.innerHTML = '';
            
            columns.forEach((col, index) => {
                if (col.name !== 'No' && col.name !== 'é¡§å®¢å' && col.name !== 'å·¥äº‹No') {
                    const label = document.createElement('label');
                    label.className = 'column-checkbox';
                    label.innerHTML = `
                        <input type="checkbox" ${col.visible ? 'checked' : ''} 
                               data-column-index="${index}">
                        ${col.name}
                    `;
                    selector.appendChild(label);
                }
            });
            
            document.getElementById('columnVisibilityModal').style.display = 'block';
        }
        
        function applyColumnVisibility() {
            const checkboxes = document.querySelectorAll('#columnSelector input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.getAttribute('data-column-index'));
                columns[index].visible = checkbox.checked;
            });
            renderTable();
            closeModal('columnVisibilityModal');
            saveData();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function addRow() {
            const position = document.getElementById('rowPosition').value;
            const newRow = {
                'No': position === 'end' ? data.length + 1 : parseInt(position) + 1,
                'é¡§å®¢å': document.getElementById('customerName').value,
                'å·¥äº‹No': document.getElementById('workNumber').value,
                'ãƒ•ãƒªã‚¬ãƒŠ': document.getElementById('furigana').value,
                'å»ºç¯‰åœ°': document.getElementById('buildingLocation').value,
                'èè³‡': document.getElementById('financing').value
            };
            
            columns.forEach(col => {
                if (!newRow[col.name]) {
                    newRow[col.name] = '';
                }
            });
            
            if (position === 'end') {
                data.push(newRow);
            } else {
                data.splice(parseInt(position), 0, newRow);
                data.forEach((row, index) => {
                    row.No = index + 1;
                });
            }
            
            updateCustomerList();
            updatePositionSelects();
            renderTable();
            saveData();
            hideAddCustomerForm();
            showNotification('é¡§å®¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }
        
        function deleteRow(index) {
            if (confirm('ã“ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                data.splice(index, 1);
                data.forEach((row, index) => {
                    row.No = index + 1;
                });
                updateCustomerList();
                updatePositionSelects();
                renderTable();
                saveData();
                showNotification('é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }
        
        function addColumn() {
            const columnName = document.getElementById('columnName').value.trim();
            const position = document.getElementById('columnPosition').value;
            
            if (!columnName) {
                alert('åˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (columns.some(col => col.name === columnName)) {
                alert('åŒã˜åå‰ã®åˆ—ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }
            
            const newColumn = { name: columnName, visible: true, fixed: false };
            
            if (position === 'end') {
                columns.push(newColumn);
            } else {
                columns.splice(parseInt(position), 0, newColumn);
            }
            
            data.forEach(row => {
                row[columnName] = '';
            });
            
            updateColumnList();
            updatePositionSelects();
            renderTable();
            saveData();
            hideAddColumnForm();
            showNotification('åˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }
        
        function updateCell(rowIndex, column, value) {
            data[rowIndex][column] = value;
            saveData();
            
            if (event && event.target) {
                const element = event.target.parentElement || event.target;
                element.classList.add('highlight');
                setTimeout(() => {
                    element.classList.remove('highlight');
                }, 1000);
            }
        }
        
        function saveData() {
            const office = document.getElementById('office').value;
            const year = document.getElementById('year').value;
            const saveKey = `taskProgress_${office}_${year}`;
            localStorage.setItem(saveKey, JSON.stringify({
                columns: columns,
                data: data,
                cellInputTypes: cellInputTypes
            }));
            
            // ç·¨é›†ä¸­ã®è­¦å‘Šã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            document.getElementById('editStatus').classList.add('active');
            setTimeout(() => {
                document.getElementById('editStatus').classList.remove('active');
            }, 3000);
            
            showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }
        
        function loadData() {
            const office = document.getElementById('office').value;
            const year = document.getElementById('year').value;
            const saveKey = `taskProgress_${office}_${year}`;
            const saved = localStorage.getItem(saveKey);
            
            if (saved) {
                const parsed = JSON.parse(saved);
                columns = parsed.columns || columns;
                data = parsed.data || [];
                cellInputTypes = parsed.cellInputTypes || {};
            } else {
                data = [];
                cellInputTypes = {};
            }
        }
        
        function exportToCSV() {
            const visibleColumns = columns.filter(col => col.visible);
            const headers = visibleColumns.map(col => col.name);
            
            let csv = headers.join(',') + '\n';
            
            data.forEach((row, index) => {
                const rowData = visibleColumns.map(col => {
                    const value = col.name === 'No' ? (row.No || index + 1) : (row[col.name] || '');
                    const escaped = String(value).replace(/"/g, '""');
                    return escaped.includes(',') || escaped.includes('\n') ? `"${escaped}"` : escaped;
                });
                csv += rowData.join(',') + '\n';
            });
            
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ¥­å‹™é€²æ—ç®¡ç†_${document.getElementById('office').value}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        }
        
        function importData() {
            document.getElementById('fileInput').click();
        }
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        columns = imported.columns || columns;
                        data = imported.data || [];
                        cellInputTypes = imported.cellInputTypes || {};
                        updatePositionSelects();
                        renderTable();
                        saveData();
                        showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                    } catch (err) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                };
                reader.readAsText(file);
            }
        });
        
        // Excelãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å‡¦ç†ï¼ˆçµåˆã‚»ãƒ«å¯¾å¿œç‰ˆï¼‰
        document.getElementById('excelFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                
                // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                if (file.name.endsWith('.csv')) {
                    reader.onload = function(e) {
                        try {
                            const text = e.target.result;
                            const rows = text.split('\n').map(row => row.split(',').map(cell => cell.trim()));
                            processSimpleCSVData(rows);
                        } catch (error) {
                            showNotification('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
                            console.error(error);
                        }
                    };
                    reader.readAsText(file, 'UTF-8');
                } else {
                    // Excelãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { 
                                type: 'array',
                                cellStyles: true,
                                cellFormula: true,
                                cellDates: true,
                                sheetStubs: true,
                                raw: true
                            });
                            
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            
                            // çµåˆã‚»ãƒ«ã®æƒ…å ±ã‚’å–å¾—
                            const merges = worksheet['!merges'] || [];
                            
                            // sheet_to_jsonã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                                header: 1,
                                raw: false,
                                defval: ''
                            });
                            
                            // çµåˆã‚»ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹
                            if (merges.length > 0) {
                                merges.forEach(merge => {
                                    const startRow = merge.s.r;
                                    const endRow = merge.e.r;
                                    const startCol = merge.s.c;
                                    const endCol = merge.e.c;
                                    
                                    // çµåˆã‚»ãƒ«ã®å€¤ã‚’å–å¾—
                                    const value = jsonData[startRow] && jsonData[startRow][startCol] ? 
                                                 jsonData[startRow][startCol] : '';
                                    
                                    // çµåˆç¯„å›²å†…ã®ã‚»ãƒ«ã«åŒã˜å€¤ã‚’è¨­å®š
                                    for (let r = startRow; r <= endRow; r++) {
                                        if (!jsonData[r]) jsonData[r] = [];
                                        for (let c = startCol; c <= endCol; c++) {
                                            jsonData[r][c] = value;
                                        }
                                    }
                                });
                            }
                            
                            processExcelData(jsonData);
                        } catch (error) {
                            showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
                            console.error(error);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            }
        });
        
        function processSimpleCSVData(rows) {
            const newData = [];
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿è¡Œã®ã¿å‡¦ç†
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row && row[0] && row[0].trim()) {
                    const newRow = {
                        'No': newData.length + 1,
                        'é¡§å®¢å': row[0].trim(),
                        'å·¥äº‹No': row[1] ? row[1].trim() : ''
                    };
                    
                    // ä»–ã®åˆ—ã¯ç©ºã§åˆæœŸåŒ–
                    columns.forEach(col => {
                        if (!newRow[col.name]) {
                            newRow[col.name] = '';
                        }
                    });
                    
                    newData.push(newRow);
                }
            }
            
            if (newData.length > 0) {
                if (confirm(`${newData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ`)) {
                    data = newData;
                    updatePositionSelects();
                    renderTable();
                    saveData();
                    showNotification('CSVãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                }
            } else {
                showNotification('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', true);
            }
        }
        
        function processExcelData(rows) {
            let headerRowIndex = -1;
            for (let i = 0; i < Math.min(10, rows.length); i++) {
                if (rows[i] && rows[i].includes('é¡§å®¢å')) {
                    headerRowIndex = i;
                    break;
                }
            }
            
            if (headerRowIndex === -1) {
                showNotification('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', true);
                return;
            }
            
            const headers = rows[headerRowIndex];
            const newData = [];
            
            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (row && row[1] && row[1].toString().trim()) {
                    const newRow = {};
                    
                    headers.forEach((header, index) => {
                        if (header && header.toString().trim()) {
                            let normalizedHeader = header.toString().trim()
                                .replace(/\r\n/g, '')
                                .replace(/\n/g, '')
                                .replace(/\r/g, '');
                            
                            const value = row[index];
                            if (value !== null && value !== undefined) {
                                if (typeof value === 'object' && value.constructor.name === 'Date') {
                                    // Excelã®æ—¥ä»˜ã‚’å‡¦ç†
                                    const month = value.getMonth() + 1;
                                    const day = value.getDate();
                                    newRow[normalizedHeader] = `${month}/${day}`;
                                } else {
                                    newRow[normalizedHeader] = value.toString();
                                }
                            } else {
                                newRow[normalizedHeader] = '';
                            }
                        }
                    });
                    
                    if (!newRow['No']) {
                        newRow['No'] = newData.length + 1;
                    }
                    
                    newData.push(newRow);
                }
            }
            
            if (newData.length > 0) {
                if (confirm(`${newData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ`)) {
                    data = newData;
                    
                    Object.keys(newData[0]).forEach(key => {
                        if (!columns.some(col => col.name === key)) {
                            columns.push({ name: key, visible: true, fixed: false });
                        }
                    });
                    
                    updatePositionSelects();
                    renderTable();
                    saveData();
                    showNotification('ã‚¨ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                }
            } else {
                showNotification('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', true);
            }
        }
        
        function showNotification(message, isWarning = false) {
            const notification = document.createElement('div');
            notification.className = isWarning ? 'notification warning' : 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }// å›ºå®šåˆ—è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
function showColumnSettingsModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.id = 'columnSettingsModal';
    
    let content = `
        <div class="modal-content">
            <h3 class="modal-header">åˆ—ã®å›ºå®šè¨­å®š</h3>
            <div class="column-settings-list">
    `;
    
    columns.forEach((col, index) => {
        if (col.name !== 'No') {  // Noåˆ—ã¯å¤‰æ›´ä¸å¯
            content += `
                <div class="column-setting-item">
                    <span>${col.name}</span>
                    <label>
                        <input type="checkbox" 
                               ${col.fixed ? 'checked' : ''} 
                               onchange="toggleColumnFixed(${index})">
                        å›ºå®šåˆ—ã«ã™ã‚‹
                    </label>
                </div>
            `;
        }
    });
    
    content += `
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="applyColumnSettings()">é©ç”¨</button>
                <button class="btn btn-danger" onclick="closeModal('columnSettingsModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    `;
    
    modal.innerHTML = content;
    document.body.appendChild(modal);
}

// åˆ—ã®å›ºå®šçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
function toggleColumnFixed(index) {
    columns[index].fixed = !columns[index].fixed;
}

// åˆ—ã®è¨­å®šã‚’é©ç”¨
function applyColumnSettings() {
    renderTable();
    saveData();
    document.getElementById('columnSettingsModal').remove();
    showNotification('åˆ—ã®è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}
        
        // å¹´åº¦å¤‰æ›´æ™‚ã®å‡¦ç†
        document.getElementById('year').addEventListener('change', function() {
            loadData();
            updatePositionSelects();
            renderTable();
        });
        
        // å–¶æ¥­æ‰€å¤‰æ›´æ™‚ã®å‡¦ç†
        document.getElementById('office').addEventListener('change', function() {
            loadData();
            updatePositionSelects();
            renderTable();
        });
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    saveData();
                }
            }
        });
        
        // åˆæœŸåŒ–
        initializeTable();
    </script>
</body>
</html>
